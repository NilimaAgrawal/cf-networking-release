#!/bin/bash -eu

<% unless p("cf_networking.disable") %>
source /var/vcap/packages/ctl-utils/ctl_util.sh

export RUN_DIR=/var/vcap/sys/run/silk-daemon
export LOG_DIR=/var/vcap/sys/log/silk-daemon
export PIDFILE=${RUN_DIR}/silk-daemon.pid
export URL=127.0.0.1:<%= p("cf_networking.silk_daemon.listen_port") %>
export TIMEOUT=20

mkdir -p /var/vcap/sys/log/monit
exec 1>> /var/vcap/sys/log/monit/silk-daemon.out.log
exec 2>> /var/vcap/sys/log/monit/silk-daemon.err.log

case $1 in

  start)
    trap 'handle_orphaned_server silk-daemon ${pid}' TERM

    mkdir -p ${RUN_DIR}
    mkdir -p ${LOG_DIR}

    /var/vcap/packages/silk-daemon/bin/silk-daemon \
         -config=/var/vcap/jobs/silk-daemon/config/client-config.json \
         2> >(tee -a ${LOG_DIR}/silk-daemon.stderr.log | logger -p user.error -t silk-daemon) \
         1> >(tee -a ${LOG_DIR}/silk-daemon.stdout.log | logger -t silk-daemon) &

    pid=$!

    healthy=$(wait_for_server_to_become_healthy ${URL} ${TIMEOUT})
    write_pid ${healthy} ${pid}

    ;;

  stop)

    stop_process

    ;;

  *)
    echo "Usage: $0 {start|stop}"

    ;;

esac
<% end %>
